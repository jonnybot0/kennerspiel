machine:
  environment:
    JAVA_TOOL_OPTIONS: '-Dfile.encoding=UTF8 -Duser.timezone=UTC'
    _JAVA_OPTIONS: '-Xms512m -Xmx1024m -Xss2m'
  services:
    - docker
  java:
    version: oraclejdk8
  python:
    version: 2.7.6

dependencies:
  cache_directories:
    - ~/.sbt
  pre:
    - pip install awscli
  override:
    - "./activator compile":
        timeout: 300
test:
  override:
    - "./activator test docker:stage":
        timeout: 900
  post:
    - cp -R target/test-reports $CI_REPORTS
    - cp target/docker; zip -r ../kennerspiel-docker-$CIRCLE_SHA1.zip .; cd ../../
    - cp target/kennerspiel-docker-$CIRCLE_SHA1.zip $CIRCLE_ARTIFACTS

deployment:
  prod:
    branch: master
    commands:
      - aws s3 cp $CIRCLE_ARTIFACTS/kennerspiel-docker-$CIRCLE_SHA1.zip s3://kennerspiel-deployments/kennerspiel-docker-$CIRCLE_SHA1.zip
      - aws elasticbeanstalk create-application-version --application-name kennerspiel-app --version-label $CIRCLE_SHA1 --source-bundle S3Bucket=kennerspiel-deployments,S3Key=kennerspiel-docker-$CIRCLE_SHA1.zip --region us-west-2
      - aws elasticbeanstalk update-environment --environment-name kennerspiel-app --version-label $CIRCLE_SHA1 --region us-west-2
